<!doctype html><html><head><meta charset=UTF-8><title>Node.js APM 调研及原理分析 - By 齐云雷</title><link rel=stylesheet href=//cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css><link rel=stylesheet href=//cdn.staticfile.org/prism/1.15.0/themes/prism.min.css><link rel=stylesheet href=//cdn.staticfile.org/KaTeX/0.10.0-rc.1/katex.min.css><link rel=stylesheet href=//cdn.staticfile.org/prism/1.15.0/themes/prism-okaidia.min.css><link href=./css/chunk-vendors.6415362d.css rel=stylesheet></head><body><div><article id=webslides><section slide class="slide bg-blue aligncenter" video="https://embedwistia-a.akamaihd.net/deliveries/93b871eac3d0214e774b186f5165945b244c0fa6/file.mp4 poster='https://embedwistia-a.akamaihd.net/deliveries/430ef83fc694f1ba9f548da1cd8eb56992f7f53d.jpg' .dark"><video poster=https://embedwistia-a.akamaihd.net/deliveries/430ef83fc694f1ba9f548da1cd8eb56992f7f53d.jpg loop muted autoplay preload=true class="background-video dark"><source src=https://embedwistia-a.akamaihd.net/deliveries/93b871eac3d0214e774b186f5165945b244c0fa6/file.mp4></video><div class=wrap wrap=true><h1 class="text-landing text-shadow">Node.js APM 调研及原理分析</h1></div></section><section slide class="slide bg-black-blue aligncenter"><div class=wrap wrap=true><h1>APM</h1><hr><div class="size-60 aligncenter"><h3><a href=https://en.wikipedia.org/wiki/Application_performance_management target=_blank>Application Performance Management</a></h3><h3>监控服务的一套技术手段，致力于监控并管理程序的性能和可用性</h3></div></div></section><section slide class="slide bg-black-blue aligncenter"><div class=wrap wrap=true><p><img src=./img/apm-coneptual-framework.9500cd14.jpg alt="APM Coneptual Framework"></p></div></section><section slide class="slide bg-black-blue aligncenter"><div class=wrap wrap=true><h1>APM的定义</h1><hr><div class="size-80 aligncenter" style=font-size:30px><ul><li>终端用户体验</li><li>应用架构映射</li><li>应用事务分析</li><li>深度应用诊断</li><li>分析与报告</li></ul></div></div></section><section slide class="slide bg-black-blue aligncenter"><div class=wrap wrap=true><h4>2016 年， Gartner 又将上述 5 个维度更新为 3 个新维度。</h4><hr><div class="size-80 aligncenter" style=font-size:30px><ul><li>数字体验监控 (DEM)</li><li>应用发现、跟踪、诊断 (ADTD)</li><li>应用分析 (AA)</li></ul></div></div></section><section slide class="slide bg-black-blue aligncenter"><div class=wrap wrap=true><h1>市场调研-商业软件</h1></div></section><section slide class="slide bg-black-blue slide-top" image="https://newrelic.com/assets/pages/apm/nodejs/apm-nodejs-transactions-dashboard-ab492ad569f7cc997a2dbdf6921e07f7.png .dark"><span class="background dark" style="background-image:url('https://newrelic.com/assets/pages/apm/nodejs/apm-nodejs-transactions-dashboard-ab492ad569f7cc997a2dbdf6921e07f7.png')"></span><div class=wrap wrap=true><h1><a href=https://newrelic.com/nodejs target=_blank>New Relic</a></h1><hr><div class=content-left><p>Node.js APM 产业的龙头，虽然监控服务需要付费，数据上传到云端才能使用，但其 Agent 源代码完全开放。</p><p>付费用户的首选。</p></div></div></section><section slide class="slide bg-black-blue slide-top" image="https://www.appdynamics.com/media/uploaded-images/1503958536/.thumbnails/node.js-performance-monitoring-figure-6-500x0_q100.png .dark"><span class="background dark" style="background-image:url('https://www.appdynamics.com/media/uploaded-images/1503958536/.thumbnails/node.js-performance-monitoring-figure-6-500x0_q100.png')"></span><div class=wrap wrap=true><h1><a href=https://www.appdynamics.com/nodejs target=_blank>AppDynamics</a></h1><hr><div class=content-left><p>专攻企业级服务，支持部署在公司内部数据中心。</p><p>其 Agent 代码不完全开放，使用了经过编译的 jar 包和二进制文件。</p></div></div></section><section slide class="slide bg-black-blue slide-top" image="https://dt-cdn.net/images/nodejs-heap-memory-analysis-2500-e9e25c6522.png .dark"><span class="background dark" style="background-image:url('https://dt-cdn.net/images/nodejs-heap-memory-analysis-2500-e9e25c6522.png')"></span><div class=wrap wrap=true><h1><a href=https://www.dynatrace.com/technologies/nodejs-monitoring/ target=_blank>Dynatrace</a></h1><hr><div class=content-left><p>在 Node.js 的市场占有率和热度较低，不开放源代码，无法深度化定制。</p></div></div></section><section slide class="slide bg-black-blue slide-top" image="https://www.atatus.com/images/product/apm/pages/apm_dashboard.png .dark"><span class="background dark" style="background-image:url('https://www.atatus.com/images/product/apm/pages/apm_dashboard.png')"></span><div class=wrap wrap=true><h2><a href=https://www.atatus.com/for/nodejs target=_blank>Atatus</a></h2><hr><div class=content-left><p>支持功能一般，SDK 做了代码混淆。</p></div></div></section><section slide class="slide bg-black-blue slide-top" image="https://www.tingyun.com/wp-content/themes/tingyun/images/solu-img2.png .dark"><span class="background dark" style="background-image:url('https://www.tingyun.com/wp-content/themes/tingyun/images/solu-img2.png')"></span><div class=wrap wrap=true><h2><a href=https://doc.tingyun.com/server/html/node/install.html target=_blank>听云</a></h2><hr><div class=content-left><p>部分功能（代码）借鉴自 New Relic，针对国内市场做了一些本地化。</p></div></div></section><section slide class="slide bg-black-blue slide-top" image="https://static.oneapm.com/assets/sites2/images/ai/cc1826bd.2-2.png .dark"><span class="background dark" style="background-image:url('https://static.oneapm.com/assets/sites2/images/ai/cc1826bd.2-2.png')"></span><div class=wrap wrap=true><h2><a href=https://www.oneapm.com/ai/nodejs.html target=_blank>OneAPM</a></h2><hr><div class=content-left><p>定位类似听云。</p></div></div></section><section slide class="slide bg-black-blue aligncenter"><div class=wrap wrap=true><h1>市场调研-开源/免费软件</h1></div></section><section slide class="slide bg-black-blue slide-top" image="https://img.alicdn.com/tfs/TB1_idMa3MPMeJjy1XdXXasrXXa-1358-803.png .dark"><span class="background dark" style="background-image:url('https://img.alicdn.com/tfs/TB1_idMa3MPMeJjy1XdXXasrXXa-1358-803.png')"></span><div class=wrap wrap=true><h1><a href=https://cn.aliyun.com/product/nodejs target=_blank>Alinode</a></h1><hr><div class=content-left><p>Runtime？</p><p>数据安全？</p><p>争议较大...</p></div></div></section><section slide class="slide bg-black-blue slide-top" image="https://img.alicdn.com/tfs/TB1_idMa3MPMeJjy1XdXXasrXXa-1358-803.png .dark"><span class="background dark" style="background-image:url('https://img.alicdn.com/tfs/TB1_idMa3MPMeJjy1XdXXasrXXa-1358-803.png')"></span><div class=wrap wrap=true><h1><a href=https://cn.aliyun.com/product/nodejs target=_blank>Alinode</a></h1><hr><div class=content-left><p>Alinode 对 Node Runtime 增加了哪些改动？</p><p>• 增加了一些 V8 没有对外暴露的接口，比如 GC Trace 来动态输出 GC 日志</p><p>• 埋了一些点以性能损耗更低的方式采集进程级别的 CPU 和 Memory 数据</p><p>• 增加了动态开启 CPU / Memory / GC 状态采集的开关</p><blockquote><p>对于负责开发者业务相关的 API 和功能逻辑，并无任何改动，AliNode 和官方的 Runtime 可以无缝对切的原因。</p></blockquote></div></div></section><section slide class="slide bg-black-blue slide-top" image="https://img.alicdn.com/tfs/TB1_idMa3MPMeJjy1XdXXasrXXa-1358-803.png .dark"><span class="background dark" style="background-image:url('https://img.alicdn.com/tfs/TB1_idMa3MPMeJjy1XdXXasrXXa-1358-803.png')"></span><div class=wrap wrap=true><h1><a href=https://cn.aliyun.com/product/nodejs target=_blank>Alinode</a></h1><hr><div class=content-left><p><strong>安全问题</strong></p><p>主要是担心会采集业务数据上报，但是实际上 AliNode 内核的上述改动，都不会直接向云端发送任何数据，而都是以本地 Log 的方式写入大家配置的 NODE_LOG_DIR 目录下，日志文件以 <code>node-日志.log</code> 的形式命名。</p><p>控制台看到的数据均是通过 agentx 这个库采集上报的，这个库是开源的。</p></div></div></section><section slide class="slide bg-black-blue slide-top" image="https://static.cnodejs.org/FnYogKudNxd92qVSZ19cl3e4dWF5 .dark"><span class="background dark" style="background-image:url('https://static.cnodejs.org/FnYogKudNxd92qVSZ19cl3e4dWF5')"></span><div class=wrap wrap=true><h1><a href=https://github.com/hyj1991/easy-monitor target=_blank>Easy Monitor</a></h1><hr><div class=content-left><p>功能相对简单，仅提供性能监控与分析，维护度较低。</p><p>目前最大的价值是作为学习项目，而不是投入生产环境。</p></div></div></section><section slide class="slide bg-black-blue slide-top" image="https://img.alicdn.com/tfs/TB1k04KhY_I8KJjy1XaXXbsxpXa-2540-1996.png .dark"><span class="background dark" style="background-image:url('https://img.alicdn.com/tfs/TB1k04KhY_I8KJjy1XaXXbsxpXa-2540-1996.png')"></span><div class=wrap wrap=true><h1><a href=https://midwayjs.org/pandora/zh-cn/ target=_blank>Pandora.js</a></h1><hr><div class=content-left><p>来自淘宝 midwayjs 团队的进程启动器，阿里内部已经落地，正在重构 2.0 版本。</p><p>目前不支持平滑重启，Dashboard 只能单机部署单机监控，无法集群监控，midway 的使用方案是结合 ElasticSearch。</p></div></div></section><section slide class="slide bg-black-blue slide-top" image="https://prometheus.io/assets/grafana_prometheus.png .dark"><span class="background dark" style="background-image:url('https://prometheus.io/assets/grafana_prometheus.png')"></span><div class=wrap wrap=true><h1><a href=https://prometheus.io/ target=_blank>Prometheus</a></h1><hr><div class=content-left><p>在国外非常流行，相比业务方，更多地被运维熟知，是一种监控和报警的开源生态。Agent 和界面有多重组合方式，Node.js 一般结合 <code>prom-client</code>(非官方 npm 包) + <code>Granfana</code> 使用。</p><p>只做性能采集，不支持 trace 跟踪。目前已知缺陷是内存占用较高和日志量巨大，数据可以选择本地存储或远程接口存储。</p><p>开源的一大选择方案，落地可能对运维团队要求较高</p></div></div></section><section slide class="slide bg-black-blue slide-top" image="https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blte0af23fc549e1e02/5ca6865b154fe31d3366fa5e/apm-animation-opbeans-python-app.gif .dark"><span class="background dark" style="background-image:url('https://static-www.elastic.co/v3/assets/bltefdd0b53724fa2ce/blte0af23fc549e1e02/5ca6865b154fe31d3366fa5e/apm-animation-opbeans-python-app.gif')"></span><div class=wrap wrap=true><h1><a href=https://www.elastic.co/solutions/apm target=_blank>Elastic APM</a></h1><hr><div class=content-left><p>Elastic 体系下的完全开源的 APM 解决方案，也提供商业付费服务。</p><p>apm-server ElasticSearch，Kibana 内置了 APM 基础看板。</p><p>官方提供 API 来支持深度定制，golang 降低了二次开发的成本，更不用担心 Kibana 看板功能不够用。总之，是相当全面的解决方案。</p></div></div></section><section slide class="slide bg-black-blue aligncenter"><div class=wrap wrap=true><h1>选型概述</h1></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>主要维度</h1><hr><div style=font-size:24px><ul class=flexblock><li>• 性能监控</li><li>• 代码级监控</li><li>• 事务监控</li><li>• 框架支持</li><li>• 链路追踪</li><li>• 分布式部署</li><li>• 代码侵入</li><li>• 社区活跃度</li><li>• 数据安全</li><li><p>• 外部依赖</p></li></ul></div></div></section><section slide class="slide bg-black-blue aligncenter"><div class=wrap wrap=true><table><thead><tr><th>名称</th><th>Express</th><th>Koa</th><th>性能</th><th>代码级</th><th>事务</th><th>链路</th><th>分布式</th><th>侵入</th><th>实现方式</th><th>npm周下载量(+)</th></tr></thead><tbody><tr><td>newrelic</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>低</td><td>探针</td><td>30.1k</td></tr><tr><td>appdynamics</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>低</td><td>探针</td><td>9.5k</td></tr><tr><td>dynatrace</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>低</td><td>探针</td><td>0.1k</td></tr><tr><td>atatus</td><td>✓</td><td>✓</td><td>✓</td><td>×</td><td>✓</td><td>✓</td><td>✓</td><td>低</td><td>探针</td><td>0.6k</td></tr><tr><td>tingyun</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>低</td><td>探针</td><td>0.3k</td></tr><tr><td>one apm</td><td>✓</td><td>×</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>低</td><td>探针</td><td>0.1k</td></tr><tr><td>alinode</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>无</td><td>run time</td><td>-</td></tr><tr><td>easy monitor</td><td>✓</td><td>✓</td><td>✓</td><td>×</td><td>×</td><td>×</td><td>✓</td><td>低</td><td>探针</td><td>0.1k</td></tr><tr><td>pandora</td><td>✓</td><td>✓</td><td>✓</td><td>×</td><td>✓</td><td>✓</td><td>×</td><td>极低</td><td>进程启动器</td><td>0.2k</td></tr><tr><td>Prometheus</td><td>✓</td><td>✓</td><td>✓</td><td>×</td><td>✓</td><td>✓</td><td>✓</td><td>低</td><td>探针</td><td>20.1k</td></tr><tr><td>elastic apm</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td><td>低</td><td>探针</td><td>24.6k</td></tr></tbody></table></div></section><section slide class="slide bg-black-blue aligncenter"><div class=wrap wrap=true><h1>Elastic APM</h1></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>项目背景</h1><hr><div class=content-left><p>2011 年 11 月开工，至今基本都是单人维护的状态。</p><p>两任作者：</p><ul><li><p>Matt Robenolt, @Sentry core member</p></li><li><p>Thomas Watson, @Elastic Node.js dev, @Node.js core member</p></li></ul></div></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>文档建设</h1><div class=content-left><hr><ul><li><a href=https://www.elastic.co/guide/en/apm/get-started/current/index.html target=_blank>APM</a>: https://www.elastic.co/guide/en/apm/get-started/current/index.html</li><li><a href=https://www.elastic.co/guide/en/apm/agent/nodejs/current/index.html target=_blank>Node Agent</a>: https://www.elastic.co/guide/en/apm/agent/nodejs/current/index.html</li><li><a href=https://www.elastic.co/guide/en/kibana/current/xpack-apm.html target=_blank>Kibana APM</a>: https://www.elastic.co/guide/en/kibana/current/xpack-apm.html</li></ul><hr><p>一如 Elastic 其他技术栈，官方文档是相当细致了，使用前推荐阅读一遍。</p></div></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>基本功能</h1><div class=content-left><hr><ul><li>自定义 Node.js 框架和路由。</li><li>上报错误 stack，支持 source map 。</li><li>支持采集 http 请求的 body 参数（默认关闭）。</li><li>过滤敏感信息，根据请求头、或自定义维度。</li><li>定制上报 Transaction、Span、额外的 Custom 数据。</li><li>性能优化：调整采样率、上报频率、请求体的限制。</li><li>opentracing</li><li>kubernetes</li><li><a href=http://apm.guahao.cn/app/kibana target=_blank>...</a></li></ul></div></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>数据上报</h1><hr><div class=content-center><p><br><br></p><pre class="animated fadeInUp language-textile language-textile"><code class="animated fadeInUp language-textile"><span class="token phrase">elastic<span class="token inline"><span class="token punctuation">-</span><span class="token deleted">apm</span><span class="token punctuation">-</span></span>node(node)  ➡   apm-server(golang)
                                   ⬇
     kibana(展示层)      ➡   elasticsearch(数据层)
</span></code></pre></div></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>目录结构</h1><hr><div class=content-center><ul><li>lib<ul><li>filters</li><li>instrumentation<ul><li>module</li></ul></li><li>metrics<ul><li>platform</li></ul></li><li>middleware</li></ul></li></ul></div></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>核心功能</h1><hr><div class=content-center><h4>Transaction</h4><hr><h4>Error</h4><hr><h4>Metric</h4><hr></div></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>Error</h1><div class=content-center><pre class=language-js><code class=language-js><span class="token keyword">var</span> formatter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./lib/node-0.10-formatter'</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> orig <span class="token operator">=</span> Error<span class="token punctuation">.</span>prepareStackTrace
Error<span class="token punctuation">.</span><span class="token function-variable function">prepareStackTrace</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> callsites</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">'__error_callsites'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    enumerable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    configurable<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    writable<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    value<span class="token punctuation">:</span> callsites
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token punctuation">(</span>orig <span class="token operator">||</span> formatter<span class="token punctuation">)</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> callsites<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  err<span class="token punctuation">.</span>stack
  <span class="token keyword">return</span> err<span class="token punctuation">.</span>__error_callsites
<span class="token punctuation">}</span>
</code></pre></div></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>Error</h1><div class=content-center><pre class=language-js><code class=language-js>Error<span class="token punctuation">.</span><span class="token function">prepareStackTrace</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> structuredStackTrace<span class="token punctuation">)</span>
</code></pre><p>这个接口常常被用来格式化错误信息，<code>structuredStackTrace</code> 包含了一组 CallSite 对象，CallSite 对象支持的方法有：</p><p>getThis, getTypeName, getFunction, getFunctionName, getMethodName, getFileName, getLineNumber, getColumnNumber, getEvalOrigin, isToplevel, isEval, isNative, isConstructor, isAsync, isPromiseAll, getPromiseIndex</p><p>借助 CallSite 可以拿到 Error 抛出的文件、行列位置。</p></div></div></section><section slide class="slide bg-black-blue aligncenter"><div class=wrap wrap=true><h1>Metric</h1></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>Metric概述</h1><hr><div class=content-center><p>一般来说，Node.js 原生暴露的接口足够对进程性能的基本状况有所判断了，但 APM 系统总是希望监控更详细的信息。尤其是系统 CPU、内存占用率的走势图。一部分探针选择用纯 JS 计算，另一部分探针选择使用 C++ 获取/计算。使用 C++ 的库一般还会获取更复杂的指标，如 <a href=https://github.com/RuntimeTools/appmetrics target=_blank>appmetrics</a> 会获取一部分 GC、Event loop 信息。</p></div></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>Elastic Metric</h1><hr><div class=content-center><ul><li>/proc/meminfo: 记录系统内存信息，用来获取两个指标：MemAvailable 和 MemTotal。对应 <code>os.totalmem()</code> 和 <code>os.freemem()</code>。</li><li>/proc/stat: 记录 CPU 活动信息，用来获取两个指标：cpuTotal 和 cpuUsage。这一步用 Node.js 计算略麻烦，需要定时缓存 <code>os.cpus()</code> 的 <code>times.total</code> <code>times.idle</code>指标。</li><li>/proc/self/stat: 不同于前面两个记录系统级信息的文件，此文件记录了当前进程的所有活动信息。用来获取进程 CPU 使用率和 RSS 内存。对应 <code>processTop.cpu().percent / cpus.length</code> 和 <code>process.memoryUsage().rss</code>。</li></ul></div></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>Transaction概述</h1><hr><div class=content-center><p>Elastic APM 中的事务，类似于 opentracing 中的 Span，但把一个请求中所有的 Span 抽象为一个概念。Transaction 实现的基础是各种代码钩子。</p></div></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>Patch</h1><hr><div class=content-center><pre class=language-js><code class=language-js><span class="token comment">// koa</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">koa<span class="token punctuation">,</span> agent<span class="token punctuation">,</span> <span class="token punctuation">{</span> version<span class="token punctuation">,</span> enabled <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enabled<span class="token punctuation">)</span> <span class="token keyword">return</span> koa

  agent<span class="token punctuation">.</span><span class="token function">setFramework</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token punctuation">:</span> <span class="token string">'koa'</span><span class="token punctuation">,</span> version<span class="token punctuation">,</span> overwrite<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> koa
<span class="token punctuation">}</span>
</code></pre></div></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><pre class=language-js><code class=language-js><span class="token comment">// koa-router</span>
<span class="token comment">// 配合 require-in-the-middle 模块食用</span>
shimmer<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span><span class="token class-name">Router</span><span class="token punctuation">.</span>prototype<span class="token punctuation">,</span> <span class="token string">'match'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">orig</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> method</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> matched <span class="token operator">=</span> <span class="token function">orig</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> method <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      agent<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'unexpected method type in koa-router prototype.match: %s'</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> method<span class="token punctuation">)</span>
      <span class="token keyword">return</span> matched
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>matched <span class="token operator">&amp;&amp;</span> matched<span class="token punctuation">.</span>pathAndMethod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> layer <span class="token operator">=</span> matched<span class="token punctuation">.</span>pathAndMethod<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">layer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> layer <span class="token operator">&amp;&amp;</span> layer<span class="token punctuation">.</span>opts <span class="token operator">&amp;&amp;</span> layer<span class="token punctuation">.</span>opts<span class="token punctuation">.</span>end <span class="token operator">===</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">var</span> path <span class="token operator">=</span> layer <span class="token operator">&amp;&amp;</span> layer<span class="token punctuation">.</span>path
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> path <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> name <span class="token operator">=</span> method <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> path
        agent<span class="token punctuation">.</span>_instrumentation<span class="token punctuation">.</span><span class="token function">setDefaultTransactionName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        agent<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'unexpected path type in koa-router prototype.match: %s'</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> path<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      agent<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'unexpected match result in koa-router prototype.match: %s'</span><span class="token punctuation">,</span> <span class="token keyword">typeof</span> matched<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> matched
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>async-hook</h1><div class=content-center><pre class=language-js><code class=language-js><span class="token comment">// 基于 async-hook 封装了 Instrumentation 的 `currentTransaction` 方法</span>
<span class="token comment">// 使异步操作中随时可以拿到当前 async scope id 下的 Transaction 实例。</span>
<span class="token keyword">const</span> asyncHooks <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'async_hooks'</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ins</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> asyncHook <span class="token operator">=</span> asyncHooks<span class="token punctuation">.</span><span class="token function">createHook</span><span class="token punctuation">(</span><span class="token punctuation">{</span> init<span class="token punctuation">,</span> before<span class="token punctuation">,</span> destroy <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> contexts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">const</span> activeTransactions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>ins<span class="token punctuation">,</span> <span class="token string">'currentTransaction'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> asyncId <span class="token operator">=</span> asyncHooks<span class="token punctuation">.</span><span class="token function">executionAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> activeTransactions<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>asyncId<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">null</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token keyword">set</span> <span class="token punctuation">(</span>trans<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> asyncId <span class="token operator">=</span> asyncHooks<span class="token punctuation">.</span><span class="token function">executionAsyncId</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>trans<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        activeTransactions<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>asyncId<span class="token punctuation">,</span> trans<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        activeTransactions<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>asyncId<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>async-hook</h1><pre class=language-js><code class=language-js><span class="token comment">// 下面是 currentTransaction 的一处应用</span>
<span class="token class-name">Instrumentation</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">bindFunction</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">original</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> original <span class="token operator">!==</span> <span class="token string">'function'</span> <span class="token operator">||</span> original<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'elasticAPMCallbackWrapper'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> original

  <span class="token keyword">var</span> ins <span class="token operator">=</span> <span class="token keyword">this</span>
  <span class="token keyword">var</span> trans <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentTransaction
  <span class="token keyword">var</span> span <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentSpan
  <span class="token keyword">if</span> <span class="token punctuation">(</span>trans <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>trans<span class="token punctuation">.</span>sampled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> original
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> elasticAPMCallbackWrapper

  <span class="token keyword">function</span> <span class="token function">elasticAPMCallbackWrapper</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> prevTrans <span class="token operator">=</span> ins<span class="token punctuation">.</span>currentTransaction
    ins<span class="token punctuation">.</span>currentTransaction <span class="token operator">=</span> trans
    ins<span class="token punctuation">.</span>bindingSpan <span class="token operator">=</span> <span class="token keyword">null</span>
    ins<span class="token punctuation">.</span>activeSpan <span class="token operator">=</span> span
    <span class="token keyword">if</span> <span class="token punctuation">(</span>trans<span class="token punctuation">)</span> trans<span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>span<span class="token punctuation">)</span> span<span class="token punctuation">.</span>sync <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token function">original</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
    ins<span class="token punctuation">.</span>currentTransaction <span class="token operator">=</span> prevTrans
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>async-hook</h1><hr><div class=content-center><ul><li><p>async hook 是 Node.js 8 以后出现的概念，为了兼容旧版本，Elastic APM 借助 <code>async-listener</code> 模块做了一些兼容，尽管 Elastic APM 官方不推荐使用低版本 Node.js 接入。</p></li><li><p>虽然 async hook 更进一步可以帮助优化异步调用栈，改善异步 Error 信息的可读性，但 APM 很难从底层判断哪些异步 CallSite 是用户想保留的，所以没有做这种处理。</p></li></ul></div></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>Stack Trace</h1><hr><div class=content-center><ul><li><p>Span 用来记录 database、http、websocket 等细致操作，Elastic APM 同时还记录了调用栈。</p></li><li><p>通常我们用 console.trace、Error 定位调用栈，实际上他们都使用来自 V8 的方法，在 Node.js 中也可以直接调用 —— <code>Error.captureStackTrace(error, constructorOpt)</code></p></li></ul><pre class=language-js><code class=language-js><span class="token comment">// error 是记录 trace 的必传对象，trace 字符串将附加到对象的 stack 属性上</span>
<span class="token comment">// constructorOpt 是用来隐藏底层调用栈的可选函数，用法如下</span>

<span class="token keyword">function</span> <span class="token function">MyError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  Error<span class="token punctuation">.</span><span class="token function">captureStackTrace</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> MyError<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Any other initialization goes here.</span>
<span class="token punctuation">}</span>
</code></pre></div></div></section><section slide class="slide bg-black-blue slide-top"><div class=wrap wrap=true><h1>小插曲</h1><hr><div class=content-center><ul><li>上面提到的 V8 Error trace API，结合 TJ 的 <code>callsite</code> 更容易理解，功能是获取当前的 CallSite 集合。</li></ul><pre class=language-js><code class=language-js>module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">var</span> orig <span class="token operator">=</span> Error<span class="token punctuation">.</span>prepareStackTrace<span class="token punctuation">;</span>
  Error<span class="token punctuation">.</span><span class="token function-variable function">prepareStackTrace</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> stack</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token keyword">return</span> stack<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> err <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">;</span>
  Error<span class="token punctuation">.</span><span class="token function">captureStackTrace</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> arguments<span class="token punctuation">.</span>callee<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> stack <span class="token operator">=</span> err<span class="token punctuation">.</span>stack<span class="token punctuation">;</span>
  Error<span class="token punctuation">.</span>prepareStackTrace <span class="token operator">=</span> orig<span class="token punctuation">;</span>
  <span class="token keyword">return</span> stack<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div></section><section slide class="slide bg-black-blue aligncenter"><div class=wrap wrap=true><h1>踩过的坑...</h1></div></section><section slide class="slide bg-black-blue aligncenter"><div class=wrap wrap=true><h1>Thank you!</h1></div></section></article></div><script>window.pluginsOptions = {}



document.addEventListener('DOMContentLoaded', () => {
    const ws = new WebSlides({
        loop: false
    })
    window.wsInstance = ws;
}, false)</script><script src=./js/chunk-vendors.2f084ea2.js></script><script src=./js/apm.c039d76e.js></script></body></html>